<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.vitalog.spring_diet.mapper.DashboardMapper">

    <!-- 전체 회원 수 -->
    <select id="countMembers" resultType="int">
        SELECT COUNT(*) FROM member
    </select>

    <!-- 평균 BMI (소수 1자리, height/weight 유효값만) -->
    <select id="avgBmi" resultType="double">
        SELECT ROUND(AVG(weight / POWER(height/100, 2)), 1)
        FROM member
        WHERE height IS NOT NULL AND height > 0
        AND weight IS NOT NULL AND weight > 0
    </select>

    <!-- 목표 달성 수: 현재체중 , 목표체중 -->
    <select id="countGoalAchieved" resultType="int">
        SELECT COUNT(*)
        FROM member
        WHERE weight IS NOT NULL
        AND goal_weight IS NOT NULL
        AND weight &lt;= goal_weight
    </select>

    <!-- 성별 분포: M/F/ETC 한 줄 집계 -->
    <select id="selectGenderRatio"
            resultType="com.vitalog.spring_diet.dto.admindashboard.GenderRatioDTO">
        SELECT
        SUM(CASE
        WHEN TRIM(UPPER(gender)) IN ('M','MALE') OR TRIM(gender) IN ('남','남자') THEN 1
        ELSE 0
        END) AS M,
        SUM(CASE
        WHEN TRIM(UPPER(gender)) IN ('F','FEMALE') OR TRIM(gender) IN ('여','여자') THEN 1
        ELSE 0
        END) AS F,
        SUM(CASE
        WHEN gender IS NULL OR
        (TRIM(UPPER(gender)) NOT IN ('M','F','MALE','FEMALE') AND TRIM(gender) NOT IN ('남','남자','여','여자'))
        THEN 1 ELSE 0
        END) AS ETC
        FROM member
    </select>


    <!-- 선택: 역할 분포 -->
    <select id="selectRoleDistribution"
            resultType="com.vitalog.spring_diet.dto.admindashboard.RoleCountDTO">
        SELECT
        role  AS "role",
        COUNT(*) AS "count"
        FROM member
        GROUP BY role
    </select>

</mapper>
