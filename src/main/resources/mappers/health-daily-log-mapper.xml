<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.vitalog.spring_diet.mapper.HealthDailyLogMapper">
    <!-- 목록 -->
    <select id="selectMyLogs" resultType="hlog">
        SELECT
        h.HNO                           AS hno
        , h.MNO                           AS mno
        , TO_CHAR(h.HDATE,'YYYY.MM.DD')   AS hdateStr
        , NVL(TO_CHAR(h.SLEEPTIME,'HH24:MI'), '00:00') AS sleeptimeStr
        , h.HWEIGHT                       AS hweight
        , h.HWEIGHT                       AS weight
        , h.WATERAMOUNT                   AS wateramount
        , h.EXERCISE                      AS exercise
        , h.FOOD                          AS food
        , TO_CHAR(h.HDATE,'YYYY-MM-DD')   AS hdate
        FROM Health_Daily_Log h
        JOIN member m ON m.mno = h.mno
        WHERE h.MNO = #{mno}
        <if test="date != null and date != ''">
            AND TRUNC(h.HDATE) = TO_DATE(#{date}, 'YYYY-MM-DD')
        </if>
        <if test="cursor != null and cursor &gt; 0">
            AND h.HNO &lt; #{cursor}
        </if>
        ORDER BY h.HDATE DESC, h.HNO DESC
        FETCH FIRST #{limit} ROWS ONLY
    </select>

    <select id="selectNextHno" resultType="int">
        SELECT SEQ_HEALTH_DAILY_LOG_HNO.NEXTVAL FROM DUAL
    </select>

    <!-- INSERT -->
    <insert id="insertHealthDailyLog" parameterType="hlog">
        INSERT INTO Health_Daily_Log (
        HNO, MNO, HDATE, SLEEPTIME, HWEIGHT, WATERAMOUNT, EXERCISE, FOOD
        ) VALUES (
        #{hno},
        #{mno},
        TO_DATE(#{hdate}, 'YYYY-MM-DD'),
        CASE
        WHEN #{sleeptime} IS NOT NULL AND #{sleeptime} != '' THEN
        TO_DATE(
        #{hdate} || ' ' ||
        LPAD(SUBSTR(#{sleeptime},1,INSTR(#{sleeptime},':')-1), 2, '0')
        || ':' ||
        LPAD(SUBSTR(#{sleeptime},INSTR(#{sleeptime},':')+1), 2, '0'),
        'YYYY-MM-DD HH24:MI'
        )
        ELSE
        TO_DATE(#{hdate} || ' 00:00', 'YYYY-MM-DD HH24:MI')
        END,
        NVL(#{hweight}, 0),
        NVL(#{wateramount}, 0),
        NVL(#{exercise}, '-'),
        NVL(#{food}, '-')
        )
    </insert>

    <!-- UPDATE -->
    <update id="updateHealthDailyLog" parameterType="hlog">
        UPDATE Health_Daily_Log
        SET
        HDATE = CASE WHEN #{hdate} IS NOT NULL AND #{hdate} != ''
        THEN TO_DATE(#{hdate}, 'YYYY-MM-DD')
        ELSE HDATE END,
        SLEEPTIME = CASE
        WHEN #{sleeptime} IS NOT NULL AND #{sleeptime} != '' THEN
        TO_DATE(
        (CASE
        WHEN #{hdate} IS NOT NULL AND #{hdate} != ''
        THEN #{hdate}
        ELSE TO_CHAR(SLEEPTIME,'YYYY-MM-DD')
        END) || ' ' ||
        LPAD(SUBSTR(#{sleeptime},1,INSTR(#{sleeptime},':')-1), 2, '0')
        || ':' ||
        LPAD(SUBSTR(#{sleeptime},INSTR(#{sleeptime},':')+1), 2, '0'),
        'YYYY-MM-DD HH24:MI'
        )
        ELSE SLEEPTIME
        END,
        HWEIGHT = NVL(#{hweight}, HWEIGHT),
        WATERAMOUNT = NVL(#{wateramount}, WATERAMOUNT),
        EXERCISE    = NVL(#{exercise}, EXERCISE),
        FOOD        = NVL(#{food}, FOOD)
        WHERE HNO = #{hno} AND MNO = #{mno}
    </update>

    <delete id="deleteHealthDailyLog">
        DELETE FROM Health_Daily_Log
        WHERE HNO = #{hno} AND MNO = #{mno}
    </delete>

    <select id="selectLatestHno" resultType="int">
        SELECT hno
        FROM Health_Daily_Log
        WHERE mno = #{mno}
        ORDER BY HDATE DESC, HNO DESC
        FETCH FIRST 1 ROWS ONLY
    </select>

    <select id="countByDate" resultType="int">
        SELECT COUNT(*)
        FROM Health_Daily_Log
        WHERE mno = #{mno}
        AND TRUNC(HDATE) = TO_DATE(#{hdate}, 'YYYY-MM-DD')
    </select>

    <select id="selectLatestWeight" resultType="double">
        SELECT HWEIGHT
        FROM Health_Daily_Log
        WHERE mno = #{mno}
        ORDER BY HDATE DESC, HNO DESC
        FETCH FIRST 1 ROWS ONLY
    </select>
</mapper>